<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Send push notifications to your phone via PUT/POST"><link href=https://blog.ntfy.sh/2023/12/06/138-lines-of-code/ rel=canonical><link rel=alternate type=application/rss+xml title="RSS feed" href=../../../../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="RSS feed of updated content" href=../../../../feed_rss_updated.xml><link rel=icon href=../../../../static/img/favicon.ico><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.4.8"><title>138 lines of code - ntfy blog</title><link rel=stylesheet href=../../../../assets/stylesheets/main.4b4a2bd9.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.356b1318.min.css><link rel=stylesheet href=../../../../static/css/extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#138-lines-of-code class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <style>
    div[data-md-component="announce"] {
        z-index: 10;
    }

    div[data-md-component="announce"] a {
        color: white;
    }

    div[data-md-component="announce"] a:hover, div[data-md-component="announce"] a:focus {
        transition: ease-in 150ms;
        color: #ccc;
    }

    div[data-md-component="announce"] .md-banner__button {
        color: #ccc;
    }

    div[data-md-component="announce"] .md-banner.hidden {
        display: none;
    }

    div[data-md-component="announce"] .twemoji {
        margin-top: 2px;
    }
</style> <button id=announce-bar-close class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"> <path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path> </svg> </button> If you like ntfy, please consider sponsoring me via <a target=_blank href=https://github.com/sponsors/binwiederhier><strong>GitHub Sponsors</strong></a> or <a href=https://en.liberapay.com/ntfy/ target=_blank><strong>Liberapay</strong></a> <svg xmlns=http://www.w3.org/2000/svg role=img viewbox="0 0 36 36" class="twemoji md-footer-custom-text"> <path fill=#DD2E44 d="M35.885 11.833c0-5.45-4.418-9.868-9.867-9.868-3.308 0-6.227 1.633-8.018 4.129-1.791-2.496-4.71-4.129-8.017-4.129-5.45 0-9.868 4.417-9.868 9.868 0 .772.098 1.52.266 2.241C1.751 22.587 11.216 31.568 18 34.034c6.783-2.466 16.249-11.447 17.617-19.959.17-.721.268-1.469.268-2.242z"/> </svg>, or subscribing to <a target=_blank href=https://ntfy.sh/app><strong>ntfy Pro</strong></a>. <script>
    announceBarKey = 'announce-bar-closed-sponsor';
    document.getElementById('announce-bar-close').addEventListener('click', (e) => {
        localStorage.setItem(announceBarKey, 'true');
        document.querySelector('div[data-md-component="announce"] .md-banner').style.display = 'none';
    });
    if (localStorage.getItem(announceBarKey) === 'true') {
        document.querySelector('div[data-md-component="announce"] .md-banner').style.display = 'none';
    }
</script> </div> </aside> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=/ title="ntfy blog" class="md-header__button md-logo" aria-label="ntfy blog" data-md-component=logo> <img src=../../../../static/img/ntfy.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> ntfy blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 138 lines of code </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/binwiederhier/ntfy title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> binwiederhier/ntfy </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=/ title="ntfy blog" class="md-nav__button md-logo" aria-label="ntfy blog" data-md-component=logo> <img src=../../../../static/img/ntfy.png alt=logo> </a> ntfy blog </label> <div class=md-nav__source> <a href=https://github.com/binwiederhier/ntfy title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> binwiederhier/ntfy </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <a href=../../../.. class=md-nav__link> <span class=md-ellipsis> Blog </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../archive/2023/ class=md-nav__link> <span class=md-ellipsis> 2023 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#publish-subscribe class=md-nav__link> Publish-subscribe </a> </li> <li class=md-nav__item> <a href=#current-architecture class=md-nav__link> Current architecture </a> <nav class=md-nav aria-label="Current architecture"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#ntfysh-server class=md-nav__link> ntfy.sh server </a> </li> <li class=md-nav__item> <a href=#publishing-notifications class=md-nav__link> Publishing notifications </a> </li> <li class=md-nav__item> <a href=#subscribing-to-topics class=md-nav__link> Subscribing to topics </a> <nav class=md-nav aria-label="Subscribing to topics"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#android-app class=md-nav__link> Android app </a> </li> <li class=md-nav__item> <a href=#ios-app class=md-nav__link> iOS app </a> </li> <li class=md-nav__item> <a href=#web-app-pwa class=md-nav__link> Web app &amp; PWA </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#emails-calls-billing class=md-nav__link> Emails, calls, billing </a> </li> <li class=md-nav__item> <a href=#monitoring-stack class=md-nav__link> Monitoring stack </a> </li> <li class=md-nav__item> <a href=#docs-blog-and-lemmy class=md-nav__link> Docs, blog, and Lemmy </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#wrapping-up class=md-nav__link> Wrapping up </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../.. class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> <span class=md-ellipsis> Back to index </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src=https://github.com/binwiederhier.png alt="Philipp C. Heckel"> </span> <span class=md-profile__description> <strong>Philipp C. Heckel</strong><br> ntfy maintainer </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> Metadata </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg> <time datetime="2023-12-06 00:00:00" class=md-ellipsis>December 6, 2023</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg> <span class=md-ellipsis> 17 min read </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <h1 id=138-lines-of-code>138 lines of code<a class=headerlink href=#138-lines-of-code title="Permanent link">&para;</a></h1> <p>Just over two years ago, I committed the first <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go>138 lines</a> of Go code to the ntfy repository. A lot has changed since then: a lot more code, a lot more features, an <a href=https://apps.apple.com/us/app/ntfy/id1625396347>iOS app</a>, an <a href="https://play.google.com/store/apps/details?id=io.heckel.ntfy">Android app</a>, a <a href=https://docs.ntfy.sh/subscribe/pwa/ >PWA</a>, countless <a href=https://docs.ntfy.sh/integrations/ >integrations</a> into all sorts of tools, and lots of tutorials and videos from ntfy fans. Crazy!</p> <p>But even though it looks as though everything changed, the basic idea behind ntfy's HTTP-based publish-subscribe mechanism remains the same as those original 138 lines of code.</p> <p>In this blog post, in honor of your birthday, little ntfy-toddler, I'd like to show you all a little bit <strong>how ntfy is architected</strong>, and how its infrastructure is set up. I hope you'll enjoy it.</p> <!-- more --> <h2 id=publish-subscribe>Publish-subscribe<a class=headerlink href=#publish-subscribe title="Permanent link">&para;</a></h2> <p>Let's start by doing a little deep dive into those <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go>138 lines of code</a>. If you're only interested in the architecture and infrastructure, you may want to <a href=#current-architecture>skip this section</a>.</p> <p>Even though the original code didn't have an Android/iOS app, it was still able to deliver on the core idea of ntfy: publishing a message via HTTP PUT, and receiving it via HTTP GET to all its subscribers.</p> <figure> <p><img alt="Core idea" src=../../../../static/img/1-initial-ntfy-architecture.svg width=500> </p> <figcaption>Publish-subscribe is the core idea of ntfy</figcaption> </figure> <p>It's actually quite remarkable how similar those few lines are to what the code looks like today -- even two years later. I thought it'd be fun to check out the code and run it, so here it goes.</p> <p>If you check out the initial commit, and run the code, you'll see something like this: </p> <div class=highlight><pre><span></span><code>git<span class=w> </span>clone<span class=w> </span>https://github.com/binwiederhier/ntfy
git<span class=w> </span>checkout<span class=w> </span>e79b50f0106ae3b515dcb26485504f42952dedf1
go<span class=w> </span>run<span class=w> </span>main.go
</code></pre></div> <p>Not much to look at, but this will start an HTTP server on port 9997 and listen for incoming HTTP connections. You can subscribe to topics via GET (e.g. <code>curl localhost:9997/mytopic</code>), and you can publish via PUT (e.g. <code>curl -X PUT -d "Hi there" localhost:9997/mytopic</code>), just like you can today with ntfy.sh or your self-hosted server.</p> <p>The code defines two handlers: one for <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L104>publishing messages</a> (HTTP PUT), and one for <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L75>receiving/subscribing</a> (HTTP GET).</p> <p>When the <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L64-L67>GET handler is called</a> (e.g. via <code>curl</code> or Postman), the code dynamically creates a topic (the code still calls this a <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L20><code>Channel</code></a>). Each topic contains a list of <code>listeners</code> (aka subscribers), which are just functions that write JSON to the HTTP response one line at a time.</p> <p>Once the listener is <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L86>added to the topic</a>, the subscriber <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L89-L92>blocks and does nothing</a>. Most importantly, it doesn't close the HTTP request, but instead just keeps the request open by not exiting the function -- identical to how long polling or <a href=https://en.wikipedia.org/wiki/Server-sent_events>server-sent events (SSE)</a> works.</p> <p>This is what allows ntfy to connect a publisher (HTTP PUT) to a subscriber: When a new message is published, the <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L125>code finds the correct topic</a> and simply <a href=https://github.com/binwiederhier/ntfy/blob/e79b50f0106ae3b515dcb26485504f42952dedf1/main.go#L113-L118>writes to all subscribers</a> with that message. Since their sockets are still open, we can just write to them directly.</p> <p>That's pretty much it. In its very basic form, this is still what ntfy does today, and <strong>you can still publish/subscribe like that using this exact same API</strong>.</p> <h2 id=current-architecture>Current architecture<a class=headerlink href=#current-architecture title="Permanent link">&para;</a></h2> <p>But of course, a lot has changed since these first 138 lines of code. I've added tons of features and many components. So let's look at what the architecture diagram looks like today.</p> <figure> <p><a href=../../../../static/img/1-ntfy-architecture.svg><img alt="Core idea" src=../../../../static/img/1-ntfy-architecture.svg></a> </p> <figcaption>ntfy architecture, as of 11/23</figcaption> </figure> <p><strong>Holy macaroni!</strong> That certainly looks a lot more complicated than the original diagram. And frankly, I didn't really expect a diagram with this many boxes when I started drawing it. But let's go through it step by step.</p> <style>
.bubble {
  border-radius: 50%;
  width: 21px;
  line-height: 21px;
  padding: 0;
  background: #eee;
  border: 1px solid #ccc;
  font-size: 0.7em;
  display: inline-block;
  text-align: center;
}
</style> <h3 id=ntfysh-server>ntfy.sh server<a class=headerlink href=#ntfysh-server title="Permanent link">&para;</a></h3> <p>In the center of the picture, you'll see the ntfy.sh server. As of today, ntfy.sh runs on a <strong>single Ubuntu-based server</strong> with 8 vCPUs and 16 GB of RAM on <a href=https://m.do.co/c/442b929528db>DigitalOcean</a> (<em>referral link</em>). </p> <p>On paper, the reliability guarantees of a single-server setup are obviously not be perfect, but in reality, <strong>this one server has worked surprisingly well</strong>. ntfy.sh handles tens of thousands of connected clients, millions of requests per day, and close to a million legitimate notifications per day, and yet that little Droplet holds up just fine. Yes, there have been a handful of (mostly) short, and self-inflicted <a href=https://ntfy.statuspage.io/ >outages</a>, and upgrades are a little challenging due to the <a href=https://en.wikipedia.org/wiki/Thundering_herd_problem>thundering herd problem</a> -- but overall, it's been rock solid. I do have plans to introduce a more resilient multi-node setup in the near future, but nothing concrete yet.</p> <p>This server, the one to rule them all, is deployed via an <a href=https://github.com/binwiederhier/ntfy-ansible>Ansible playbook</a>. As part of that playbook, the ntfy binary <span class=bubble>1</span> is deployed as a Debian package, and runs as a <a href=https://en.wikipedia.org/wiki/Systemd>systemd</a> service. The binary is an all-in-one binary: it serves the ntfy server itself (publishing, subscribing, ...), the <a href=https://ntfy.sh/docs>ntfy docs</a>, as well as the <a href=https://react.dev/ >React</a>-based <a href=https://ntfy.sh/app>web app</a>. All of these are baked into the binary itself, so no external resources are required. You may want to check out how the <a href=https://github.com/binwiederhier/ntfy-ansible/blob/main/roles/ntfy/templates/server.yml.j2>server.yml</a> on ntfy.sh is configured, to give you a better idea of the setup.</p> <p>Incoming HTTP/HTTPS-based traffic goes through <a href=http://nginx.org/ >nginx</a> <span class=bubble>2</span> and is proxied to the ntfy server via a Unix socket. This is mainly because nginx allows hot-reloading TLS certs, which we do via <a href=https://certbot.eff.org/ >certbot</a> <span class=bubble>3</span>. nginx has worked really well for me, even though the config is a little awkward, and it feels a bit dated. Though as you may or may not know, <strong><a href=https://boringtechnology.club/ >boring can be good</a></strong>, so I'm fine with that.</p> <p>As you can imagine, ntfy.sh is configured to use all of ntfy's features, so we have a dedicated folder for <a href=https://docs.ntfy.sh/config/#attachments>attachments</a> <span class=bubble>4</span>, as well as three <a href=https://www.sqlite.org/ >SQLite</a> databases: one for <a href=https://docs.ntfy.sh/config/#access-control>user and access management</a> <span class=bubble>5</span>, one for the <a href=https://docs.ntfy.sh/config/#message-cache>message cache</a> <span class=bubble>6</span>, and one to keep track of <a href=https://docs.ntfy.sh/config/#web-push>Web Push</a> subscriptions <span class=bubble>7</span>. </p> <p><strong>SQLite is awesome!</strong> Despite the significant traffic, it's been quite performant, resilient, and has not been a bottleneck -- well, at least since I added an in-memory queue and batch-based writes (see <a href=https://github.com/binwiederhier/ntfy/issues/498>GitHub</a> <a href=https://github.com/binwiederhier/ntfy/pull/502>issues</a>).</p> <p>To keep bad actors in check, ntfy is configured with strict <a href=https://docs.ntfy.sh/config/#rate-limiting>rate limits</a> (messages per day, number of subscriptions, ...), and additionally uses <a href=https://github.com/fail2ban/fail2ban>fail2ban</a> <span class=bubble>8</span> to ban misbehaving IP addresses via <a href=https://en.wikipedia.org/wiki/Iptables>iptables</a> <span class=bubble>9</span>. This is done by parsing the nginx logs <span class=bubble>10</span>, and then jailing IPs for a certain amount of time by dropping all packets. Even though fail2ban sometimes has a bad reputation, and it can be easily misconfigured to use too much CPU, it has been working great for ntfy.sh by helping to stop spammers and bad actors before they can cause too much damage. You can see how exactly fail2ban is configured in the <a href=https://github.com/binwiederhier/ntfy-ansible/tree/main/roles/fail2ban>Ansible playbook</a>.</p> <p>Aside from the ntfy application, the ntfy.sh server also houses the ntfy.sh website <span class=bubble>11</span>. The website itself is one of the few pieces in the ntfy universe that's not open source, since it is uses paid website template. The site uses React and <a href=https://tailwindcss.com/ >Tailwind CSS</a>, and is based on the <a href=https://tailwindui.com/templates/pocket>Pocket template</a>. It is deployed via GitHub Actions and rsync'd after every Git push to a certain branch.</p> <p>The only other thing on the ntfy.sh server is the <a href=https://github.com/prometheus/node_exporter>Node exporter</a> <span class=bubble>12</span>, a <a href=https://prometheus.io/ >Prometheus</a> exporter for hardware and OS metrics. This is part of the ntfy monitoring stack, which I'll discuss in more detail <a href=#monitoring-stack>in a section below</a>.</p> <h3 id=publishing-notifications>Publishing notifications<a class=headerlink href=#publishing-notifications title="Permanent link">&para;</a></h3> <p>The purpose of ntfy is to publish and receive notifications, so let's look at how we can publish messages (left side of the diagram).</p> <figure> <p><img alt="ntfy publishers" src=../../../../static/img/1-ntfy-publishers.svg> </p> <figcaption>ntfy publishers</figcaption> </figure> <p>The main way that notifications are published is via the <a href=https://docs.ntfy.sh/publish/ >HTTP-based publishing API</a> <span class=bubble>13</span>. Messages can be published via PUT/POST, including all the bells and whistles that ntfy supports (<a href=https://docs.ntfy.sh/publish/#message-title>title</a>, <a href=https://ntfy.sh/docs/publish/#message-priority>priorities</a>, <a href=https://docs.ntfy.sh/publish/#attachments>attachments</a>, ...). This is what most people use to publish messages. Just plain and simple HTTP (see <a href=https://github.com/binwiederhier/ntfy/blob/518505fa9d5d7c330e45feab542b57576f6c010d/server/server.go#L836>source code</a>), similar to what was already supported in the <a href=#publish-subscribe>original 138 lines of code</a>. </p> <p>Aside from the "normal way", it is also possible to <a href=https://docs.ntfy.sh/publish/#e-mail-publishing>publish messages by sending an email</a> to <code>ntfy-$topic@ntfy.sh</code> <span class=bubble>14</span>. Incoming emails are translated to messages by parsing the email subject and body. That works because ntfy ships with a tiny <a href=https://github.com/binwiederhier/ntfy/blob/main/server/smtp_server.go#L229>SMTP server</a>, and because DNS is configured with an <a href=https://en.wikipedia.org/wiki/MX_record>MX record</a> to allow email to be routed our way. This is a very neat feature that integrates with systems that do not speak HTTP (old routers, ...). To my surprise, I have had zero spam issues on the server, most likely because ntfy topics are password-like anyway, and because the email address has to be prefixed with <code>ntfy-</code>.</p> <p>ntfy also implements <a href=https://unifiedpush.org>UnifiedPush</a>, a standard that provides an alternative way of delivering messages from application servers to Android apps. For UnifiedPush, the ntfy server can serve as a <a href=https://unifiedpush.org/spec/definitions/#push-server>push server</a> <span class=bubble>15</span>, and as a <a href=https://unifiedpush.org/users/gateway/ >Matrix Push Gateway</a> <span class=bubble>16</span>. When acting as a push server, it pretty much does what ntfy does normally, except that topics are suffixed with <code>?up=1</code>, and can be discovered vai a <code>GET</code> request (e.g. <a href="https://ntfy.sh/uptopic?up=1">ntfy.sh/uptopic?up=1</a>). When acting as a Matrix Push Gateway, ntfy translates Matrix push messages to UnifiedPush-compatible format. It implements a subset of the <a href=https://spec.matrix.org/v1.8/push-gateway-api/ >Matrix Push Gateway specification</a>.</p> <p>The self-hosted ntfy server <span class=bubble>1*</span> in this picture is part of the <a href=#ios-app>iOS integration</a> and will be described below.</p> <h3 id=subscribing-to-topics>Subscribing to topics<a class=headerlink href=#subscribing-to-topics title="Permanent link">&para;</a></h3> <p>To subscribe to topics, and receive notifications, you can use the <a href="https://play.google.com/store/apps/details?id=io.heckel.ntfy">Android app</a> <span class=bubble>18</span>, the <a href=https://apps.apple.com/us/app/ntfy/id1625396347>iOS app</a> <span class=bubble>19</span>, the <a href=https://ntfy.sh/app>Web app</a> <span class=bubble>20</span>, the <a href=https://docs.ntfy.sh/subscribe/pwa/ >Progressive Web App</a> (also <span class=bubble>20</span>), any <a href=https://docs.ntfy.sh/integrations/ >other third party app</a> <span class=bubble>21</span>, or you can write your own. </p> <p>Lots of choices, but many of the underlying protocols for these apps are the same. The <a href=https://docs.ntfy.sh/subscribe/api/ >ntfy subscribe API</a> exposes a HTTP-based long-polling interface that can be used by any HTTP-capable clients. As of today, ntfy supports <a href=https://en.wikipedia.org/wiki/JSON_streaming>JSON streaming</a> (one JSON message per line), <a href=https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events>Server-Sent Events</a> (SSE), <a href=https://en.wikipedia.org/wiki/WebSocket>WebSocket</a> (WS), <a href=https://firebase.google.com/docs/cloud-messaging>Firebase Cloud Messaging</a> (FCM), <a href=https://web.dev/articles/push-notifications-web-push-protocol>Web Push</a>, and <a href=https://docs.ntfy.sh/subscribe/api/#poll-for-messages>HTTP/JSON-based polling</a>.</p> <p>Third party apps can pick between any of the well-documented APIs: JSON stream, SSE, or WebSocket. All three are incredibly straight forward to use and very compatible.</p> <h4 id=android-app>Android app<a class=headerlink href=#android-app title="Permanent link">&para;</a></h4> <p>One of the most common ways to subscribe to topics is the ntfy Android app (<span class=bubble>18</span>, <a href=https://github.com/binwiederhier/ntfy-android>source code</a>). It comes in two flavors: In the <a href="https://play.google.com/store/apps/details?id=io.heckel.ntfy">Google Play flavor</a>, the app uses Firebase Cloud Messaging (FCM) for all topic subscriptions on ntfy.sh, and additionally JSON stream or WebSocket if <a href=https://docs.ntfy.sh/subscribe/phone/#instant-delivery>instant delivery</a> is enabled. For all non-ntfy.sh subscriptions, and for the <a href=https://f-droid.org/en/packages/io.heckel.ntfy/ >F-Droid flavor of the app</a>, only JSON stream and WebSocket are used. </p> <figure> <p><img alt="Android examples" src=../../../../static/img/1-ntfy-examples-android.svg></p> </figure> <p>I realize that this is confusing. So let's try to make it clearer by working through two examples:</p> <ul> <li><strong>Example 1:</strong> You are subscribed to <code>ntfy.sh/mytopic</code> in the Google Play flavor of the Android app, no instant delivery. In this case, Firebase is used to deliver the message: When you publish a notification (e.g. via HTTP POST, see <span class=bubble>13</span>), nginx accepts the message <span class=bubble>2</span> and passes it to the ntfy server <span class=bubble>1</span>. The message is then forwarded to Firebase <span class=bubble>22</span>, and finally delivered to the Android app <span class=bubble>18</span>. In this case, Google delivers the message to the phone.</li> <li><strong>Example 2:</strong> You are subscribed to <code>ntfy.yourserver.de/mytopic</code>, a topic on a self-hosted ntfy server. In this case, Firebase is not used: When you publish a message <span class=bubble>13</span>, ntfy on your self-hosted server <span class=bubble>1*</span> accepts the message, and then passes it on to all active subscribers, e.g. via WebSocket or JSON stream. In this case, the Android app <span class=bubble>18</span> keeps an active connection to the ntfy server, and the message is delivered directly.</li> </ul> <p>Note that these are just examples. If you instant delivery with ntfy.sh, for instance, messages are also delivered via WebSocket or JSON stream. And if you use the F-Droid flavor of the app, Firebase is not used at all.</p> <p>In my experience, Firebase has been both a blessing and a curse: It's dead simple to use, it's free (even for millions of messages a day!), requires no additional background service, and therefore has no battery penalty. On the flip side, that means that Google sees all the messages, and sadly message delivery times are also not that great. Especially when the phone is not being used, or in power-saving mode, messages may be delayed many minutes. Overall though, I'm pretty happy with FCM.</p> <p>In general, the Android app is pretty dope (<em>if I may say so, hehe</em>). It is feature rich and rock solid, and has been working wonderfully. And people seem to like it.</p> <h4 id=ios-app>iOS app<a class=headerlink href=#ios-app title="Permanent link">&para;</a></h4> <p>Contrary to the Android app, the <a href=https://apps.apple.com/us/app/ntfy/id1625396347>ntfy iOS app</a> (<span class=bubble>19</span>, <a href=https://github.com/binwiederhier/ntfy-ios>source code</a>) has been <strong>quite the tragedy</strong> from the very start. I made it because no other open source push notification service had an iOS app at all (<em>I believe this is still true</em>), and because I thought it'd be fun. I even borrowed an old iPhone 7 (thanks Marcus!), and I bought a used MacBook just to develop it.</p> <p>And while it was a challenge to learn a new ecosystem (macOS, iOS, Swift, Swift UI, ...), and I fought a lot with things that are probably trivial to others (most notably, the MacBook keyboard), it was still fun to start from scratch and learn all these new things. </p> <p>The result is a <strong>very bare-bones iOS app</strong>: Compared to the Android app, it has a very limited amount of features (no attachments, display names, custom sounds, DND overrides, ...), and is quite frankly <a href="https://github.com/binwiederhier/ntfy/issues?q=is%3Aissue+is%3Aopen+label%3A%22%F0%9F%AA%B2+bug%22+label%3Aios">really buggy</a>. On top of that, the <a href=https://ntfy.sh/docs/config/#ios-instant-notifications>self-hosting setup is quite awkward</a>, and even requires ntfy.sh to help with instant notification delivery. It's weird, but ... it's better than nothing! </p> <p>Now let's focus on the technical details: Since iOS does not allow background processes, WebSocket or JSON stream cannot be used. Instead, Apple requires that all iOS push notifications go through the <a href=https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/sending_notification_requests_to_apns>Apple Push Notification service</a> (APNs) <span class=bubble>23</span>. APNs is similar to Google's FCM (and actually integrates really well with it), except that due to the "no background processes" restriction, it makes it the only option on iOS. It's crazy, but iOS doesn't even allow regular background polling of any kind. That means that <strong>every push notification has to go through APNs, no exceptions!</strong> While this may be alright for a central service (e.g. ntfy.sh), it makes things quite tricky for self-hosted ntfy servers.</p> <figure> <p><img alt="iOS examples" src=../../../../static/img/1-ntfy-examples-ios.svg></p> </figure> <p>Let's look at the same examples as above, but this time with the iOS app:</p> <ul> <li><strong>Example 1:</strong> You are subscribed to <code>ntfy.sh/mytopic</code> in the iOS app: When you publish a notification <span class=bubble>13</span>, nginx accepts the message <span class=bubble>2</span> and passes it to the ntfy server <span class=bubble>1</span>. The message is then forwarded to FCM <span class=bubble>22</span>, which forwards it to APNs <span class=bubble>23</span>, which delivers it to the iOS app <span class=bubble>19</span>. A lot of hops, but it works well.</li> <li><strong>Example 2:</strong> You are subscribed to <code>ntfy.yourserver.de/mytopic</code>, a topic on a self-hosted ntfy server: When you publish a message <span class=bubble>13</span>, ntfy on your self-hosted server <span class=bubble>1*</span> accepts the message, and then passes a "poll request" to ntfy.sh (<span class=bubble>1</span>), which forwards that poll request to FCM <span class=bubble>22</span>, then APNs <span class=bubble>23</span>, and the iOS device <span class=bubble>19</span>. The iOS device then asks the self-hosted server <span class=bubble>1*</span> for the message contents, and finally displays the message (for more details, see <a href=https://ntfy.sh/docs/config/#ios-instant-notifications>ntfy docs</a>).</li> </ul> <p>As you can see, the self-hosted variant is a little convoluted, and sadly still couples push notifications to the central ntfy.sh server. There just isn't another way (that I know of).</p> <h4 id=web-app-pwa>Web app &amp; PWA<a class=headerlink href=#web-app-pwa title="Permanent link">&para;</a></h4> <p>The ntfy web app <span class=bubble>20</span> is a React-based <a href=https://en.wikipedia.org/wiki/Single-page_application>single page application</a> (SPA). Just like the Android and iOS app, it can be used to subscribe to topics and publish messages. To subscribe to topics, the web app uses WebSocket, or <a href=https://web.dev/articles/push-notifications-web-push-protocol>Web Push</a> (in combination with the browsers' <a href=https://developer.mozilla.org/en-US/docs/Web/API/Push_API>Push API</a>). </p> <p>The web app comes in two flavors: A single page web app, and a <a href=https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps>Progressive Web App</a> (PWA). </p> <ul> <li><strong>Web app:</strong> A traditional web app that runs in your browser, like any other website. </li> <li><strong>Progressive Web App (PWA):</strong> The PWA lets you install the web app as a semi-native application on Windows, macOS, Linux, and even iOS and Android. To learn more and see some screenshots, check out the <a href=https://docs.ntfy.sh/subscribe/pwa/ >PWA ntfy docs</a>.</li> </ul> <figure> <p><img alt="Web app examples" src=../../../../static/img/1-ntfy-examples-web-app.svg></p> </figure> <p>Let's look at the publishing/subscribe flows again:</p> <ul> <li><strong>Example 1 (WebSocket):</strong> When WebSockets are used to subscribe to topics, the web app <span class=bubble>20</span> keeps an active connection to the ntfy server <span class=bubble>1</span> for every subscribed topic. When a message is published <span class=bubble>13</span> needs to be delivered to the web app, it is sent down via the WS connection.</li> <li><strong>Example 2 (Web Push):</strong> When Web Push is used, the web app uses the Push API to connect to the browser manufacturer's push server <span class=bubble>24</span> (Google, Microsoft, Apple, Mozilla) to subscribe. When publishing a message, the ntfy server <span class=bubble>1</span> forwards messages to the push server <span class=bubble>24</span>, which then forwards it to the browser. The message payload is encrypted, so only the ntfy server and the browser an read its contents. The benefit of using the Push API is that notifications can be delivered in the background, when the web app is not even open.</li> </ul> <p>By default, the web app uses WebSockets and the PWA uses Web Push. To enable Web Push, you can toggle "background notifications" in the settings.</p> <p>Even though the web app looks pretty simple, a lot of brainpower went into managing the various technologies. I am quite proud of it. I think it looks quite slick, and works really well.</p> <h3 id=emails-calls-billing>Emails, calls, billing<a class=headerlink href=#emails-calls-billing title="Permanent link">&para;</a></h3> <p>After looking at the core ntfy features, let's briefly check out the other peripherals:</p> <ul> <li> <p><strong>Email notifications:</strong> ntfy supports forwarding <a href=https://docs.ntfy.sh/publish/#e-mail-notifications>notifications to an email address</a> when the user supplies an <code>Email:</code> header in the HTTP PUT/POST request. ntfy.sh uses <a href=https://aws.amazon.com/ses/ >Amazon Simple Email Service</a> (SES) <span class=bubble>25</span> as an SMTP server, though when self-hosting, any SMTP server is supported. Even though this feature is available without signup, nobody has complained yet about any email spam. The reason for this is probably that it is heavily rate limited, and that the publishers IP address is listed in the email body itself. </p> </li> <li> <p><strong>Phone calls:</strong> You can use <a href=https://docs.ntfy.sh/publish/#phone-calls>ntfy to call a phone</a> and read the message out loud using text-to-speech (<em>cool, right?</em>). When a message contains a <code>Call:</code> header, and the number has been previously verified, the ntfy server talks to (<em>ha!</em>) the <a href=https://www.twilio.com/docs/voice>Twilio Voice API</a> <span class=bubble>26</span>, which then calls the phone <span class=bubble>27</span> and speaks the message. While this is a super cool feature, very few people seem to use it sadly. I certainly learned a lot when implementing this -- most importantly how much regulation exists around sending SMS messages, and how little regulation around calling phones ... which is the reason why ntfy doesn't support SMS. </p> </li> <li> <p><strong>Payments:</strong> <em>"Let's talk about billing and payments."</em> That's how every good story begins, right? Let's keep this brief: ntfy supports associating users with <a href=https://docs.ntfy.sh/config/#tiers>pre-defined tiers</a> (e.g. free tier, ntfy Pro tier, ...). To facilitate <a href=https://docs.ntfy.sh/config/#payments>payments</a> for ntfy Pro tiers, ntfy integrates with <a href=https://stripe.com>Stripe</a> <span class=bubble>28</span> by implementing the <a href=https://stripe.com/docs/payments/checkout>Stripe Checkout flow</a>, and reacting to certain incoming <a href=https://stripe.com/docs/webhooks>webhooks</a> keep the tier and payment status in sync. While payments and billing may be boring to some, <strong>I am a huge Stripe fan</strong>. I love their developer docs, and their <a href=https://stripe.com/docs/billing/testing/test-clocks>time travel feature</a>. (<em>Stripe is not a ntfy sponsor. I'm just a fan.</em>) </p> </li> </ul> <h3 id=monitoring-stack>Monitoring stack<a class=headerlink href=#monitoring-stack title="Permanent link">&para;</a></h3> <p>ntfy's monitoring stack is pretty straight forward. </p> <p>On another <a href=https://m.do.co/c/442b929528db>DigitalOcean</a> (<em>referral link</em>) Droplet, a <a href=https://prometheus.io/ >Prometheus</a> <span class=bubble>29</span> server regularly scrapes metrics from ntfy <span class=bubble>1</span> via the built-in <code>/metrics</code> endpoint (see <a href=https://docs.ntfy.sh/config/#monitoring>ntfy monitoring</a>), as well as from the <a href=https://github.com/prometheus/node_exporter>Node exporter</a> <span class=bubble>12</span> on the main server. The scraped data is then visualized via <a href=https://grafana.com/ >Grafana</a> dashboards <span class=bubble>30</span>: For the ntfy data, I use <a href=https://raw.githubusercontent.com/binwiederhier/ntfy/main/examples/grafana-dashboard/ntfy-grafana.json>this dashboard</a>, and for the Node exporter, I've found the <a href=https://grafana.com/grafana/dashboards/1860-node-exporter-full/ >Node Exporter Full</a> dashboard pretty nice. </p> <figure> <p><img alt="ntfy Grafana dashboard" src=../../../../static/img/1-ntfy-grafana.png> </p> <figcaption>ntfy Grafana dashboard</figcaption> </figure> <p>I set a number of alerts in Grafana that will send me a notification via ntfy when something goes wrong. Obviously, since we're monitoring ntfy.sh, we can't also use ntfy.sh to send the alerts. Instead, we're using <a href=https://ntfy.envs.net>ntfy.envs.net</a> <span class=bubble>31</span>, a ntfy server that is kindly provided to the public by <a href=https://envs.net/~creme/ >~creme</a>. Alerts will then be delivered to my phone <span class=bubble>32</span> via the ntfy Android app. Example alerts include high load average, high RAM usage, too many open files, too many processes in runnable state, etc.</p> <p>This stats server and the ntfy.sh server are on the same internal network, and the ntfy stats server isn't exposed to the public Internet at all. Instead, I'm using <a href=https://tailscale.com/ >Tailscale</a> as a VPN to connect the stats server and the Grafana dashboard. I've been a big fan of Tailscale since I discovered it. It's pretty magical and easy to set up, though lately I've struggled with high CPU consumption, which is a bit of a bummer. (<em>Tailscale is not a ntfy sponsor. I'm just a fan.</em>) .</p> <figure> <p><img alt=healthchecks.io src=../../../../static/img/1-ntfy-healthchecks-io.png> </p> <figcaption>ntfy healthchecks.io</figcaption> </figure> <p>Another monitoring tool that I use is <a href=https://healthchecks.io/ >healthchecks.io</a> <span class=bubble>33</span>. It's originally meant as a <a href=https://en.wikipedia.org/wiki/Dead_man%27s_switch>dead man's switch</a>, but I'm using it slightly differently to monitor ntfy.sh: <a href=https://github.com/binwiederhier/ntfy-ansible/blob/a1e891c1ec0f4157a391b6049cee35f539894c99/roles/base/files/etc/cron.d/custom#L4>Every 2 minutes</a>, my laptop, my home server, and the ntfy.sh server itself run a simple <a href=https://github.com/binwiederhier/ntfy-ansible/blob/a1e891c1ec0f4157a391b6049cee35f539894c99/roles/base/files/usr/local/bin/ntfy-health-check>healthcheck script</a> <span class=bubble>34</span>. This script publishes a ntfy message to <a href=https://ntfy.sh/healthcheck>ntfy.sh/healthcheck</a>, and then checks if the message was stored successfully on the ntfy.sh server.</p> <p>If everything works, the script will ping healthchecks.io. However, if the ntfy.sh server cannot be reached, or the message could not be delivered or retrieved, the script will fail, and healthchecks.io will not be pinged. If there is no ping within a few minutes, healtchecks.io will notify me via email, as well as via a special topic on <a href=https://ntfy.envs.net>ntfy.envs.net</a>. On my phone, this topic is configured to <strong>keep alerting and override Do Not Disturb mode</strong>, so the notification sound will ring until I acknowledge it. This is a pretty neat setup, and has helped me a few times already to catch issues early on.</p> <h3 id=docs-blog-and-lemmy>Docs, blog, and Lemmy<a class=headerlink href=#docs-blog-and-lemmy title="Permanent link">&para;</a></h3> <p>Almost done. Only three more things to talk about.</p> <p>The <a href=https://docs.ntfy.sh>ntfy docs</a> <span class=bubble>35</span> (source code), as well as <a href=https://blog.ntfy.sh>this blog</a> <span class=bubble>36</span> are hosted on <a href=https://pages.github.com/ >GitHub pages</a>. Both are using <a href=https://www.mkdocs.org/ >MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ >Material for MkDocs</a> as the theme. <strong>Material for MkDocs is such a fantastic theme, and I can't recommend it enough</strong>. It's beautiful, responsive, and has tons of features.</p> <p>The blog is deployed the normal GitHub pages way (build, git push, done), but the docs are a little different: Since the ntfy docs are included <a href=https://github.com/binwiederhier/ntfy/tree/main/docs>in the main ntfy repo</a>, but we want to host them on GitHub pages, they are built <a href=https://github.com/binwiederhier/ntfy/blob/main/.github/workflows/docs.yaml>via GitHub Actions</a> in the main repo, and git-pushed to the <a href=https://github.com/binwiederhier/ntfy-docs.github.io>ntfy-docs.github.io repo</a> and hosted by GitHub. This is a little awkward, but it works well, and it allows the docs to be included in the ntfy binary itself.</p> <p>I also host a <a href=https://lemmy.ml/ >Lemmy</a> instance called <a href=https://discuss.ntfy.sh>discuss.ntfy.sh</a> <span class=bubble>37</span>. Lemmy is a federated, open source alternative to Reddit. It's pretty neat, and I'm using it to discuss ntfy-related topics (though not so much lately). It's hosted on the tiniest <a href=https://m.do.co/c/442b929528db>DigitalOcean</a> Droplet ever, and is deployed via the <a href=https://github.com/LemmyNet/lemmy-ansible>lemmy-ansible</a> playbook. Because it's on such a tiny Droplet, it frequently runs out of memory and crashes, but at the moment, I'm not willing to invest more money to make it run well. I'm not even sure if I'll keep it around, since it's not really used much.</p> <h2 id=wrapping-up>Wrapping up<a class=headerlink href=#wrapping-up title="Permanent link">&para;</a></h2> <p>That's it! That's the ntfy architecture as of today. I hope you enjoyed this little tour. I certainly enjoyed writing it, though I must admit that it took me a lot longer than I expected. I hope it was worth it.</p> <p>My original plan for this post included a section on the future architecture, or at least on my current thoughts around how I want to change things going forward. Given that this post is already way too long, I opted to talk about architectural changes in a follow-up post. So stay tuned, or reach out via <a href=https://discord.gg/cT7ECsZj9w>Discord</a> or <a href=https://matrix.to/#/#ntfy:matrix.org>Matrix</a>.</p> <p>Thanks for reading, and thanks for using ntfy!</p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Made with  by Philipp C. Heckel </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/binwiederhier target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["search.suggest", "search.highlight", "search.share", "navigation.sections", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.81fa17fe.min.js></script> <script src=../../../../static/js/extra.js></script> </body> </html>